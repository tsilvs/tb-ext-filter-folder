# Implementation Backlog

**Version:** 2.2
**Last Updated:** 2025-12-02
**Status:** Active Development

---

## Phase 0: Architectural Foundation (Sprint 1) - HIGH PRIORITY

### 0.1 Functional Programming Refactor
**Location:** All modules
**Status:** Not Started
**Rationale:** Clean architecture impacts reliability, testability, and all future development

- [ ] Extract hardcoded values to named constants/configs
- [ ] Convert to pure functions with dependency injection
- [ ] Remove global context references via parametrization
- [ ] Eliminate OOP patterns in favor of functional composition
- [ ] Add function currying and composition patterns

**Impact:** Enables proper testing, reduces bugs, improves maintainability

**Dependencies:** None
**BRD References:** Lines 186-190, 195

---

### 0.2 Code Modularity Enhancement
**Location:** All files
**Status:** Not Started

- [ ] Extract CSS variables to theme files (colors, spacing, typography)
- [ ] Convert reusable HTML patterns to iframes (forms, lists)
- [ ] Modularize ES6 imports for maximum DRY
- [ ] Create shared utility modules
- [ ] Document module interfaces

**Impact:** Reduces duplication, accelerates future feature development

**Dependencies:** None
**BRD References:** Lines 195, 200-210

---

## Phase 1: Critical Data Handling (Sprint 2) - HIGH PRIORITY

### 1.1 Special Character & Path Sanitization
**Location:** [`RuleEngine.js`](../ext/modules/RuleEngine.js)
**Status:** Partially Complete (URL encoding exists)

**Current State:** 
- [x] URL encoding via `encodeURIComponent()` in line 162
- [ ] Validation layer for problematic characters
- [ ] User warnings for emails with special characters
- [ ] Custom mapping interface for specific emails

**Approach:** 
- Keep current encoding for URIs
- Add validation that warns users about problematic characters
- Provide custom mapping option for affected emails

**Rationale:**
- **Pro sanitization:** Some IMAP servers reject certain encoded characters; Windows filesystem restrictions
- **Con sanitization:** Creates disconnection between email and folder name
- **Solution:** Validate + warn + custom mapping > automatic replacement

**Dependencies:** Phase 0.1 (for injection pattern)
**BRD References:** Line 82

---

### 1.2 Consistent Data Formatting
**Location:** [`RuleEngine.js`](../ext/modules/RuleEngine.js), [`MailClient.js`](../ext/modules/MailClient.js)
**Status:** Not Started

- [ ] Audit all URI construction for encoding consistency
- [ ] Audit all URI parsing for decoding consistency
- [ ] Document encoding standards in code comments
- [ ] Add validation tests for encoding/decoding
- [ ] Create encoding utility module with pure functions

**Dependencies:** Phase 0.1
**BRD References:** Line 182

---

### 1.3 Collision Resolution
**Location:** [`background.js:analyze()`](../ext/background.js:8-31)
**Status:** Partially Complete (case-merge exists)

- [x] Case-insensitive merge option (line 21)
- [ ] Detect all collision types (case, special chars, encoding)
- [ ] User choice UI when collisions detected
- [ ] Collision resolution strategy config
- [ ] Logging of resolved collisions

**Dependencies:** Phase 1.1, 1.2
**BRD References:** Line 83

---

## Phase 2: Persistence & State (Sprint 3) - HIGH PRIORITY

### 2.1 Rule Storage System
**New File:** `modules/StorageManager.js`
**Status:** Not Started

- [ ] Create StorageManager module with pure functions
- [ ] Persist `msgFilterRules.dat` in `browser.storage.local`
- [ ] Account ID association schema
- [ ] Timestamp tracking (created, modified, last_sync)
- [ ] Storage quota management
- [ ] Migration utilities for schema updates
- [ ] Integration with UI for load/save

**Dependencies:** Phase 0.1 (for functional pattern)
**BRD References:** Lines 101-104

---

### 2.2 API Rate Limiting
**New File:** `modules/RateLimiter.js`
**Status:** Not Started

- [ ] Implement token bucket algorithm
- [ ] Configurable ops/second parameter
- [ ] Inject into MailClient via dependency injection
- [ ] Queue management for pending operations
- [ ] Backoff strategy for rate limit errors
- [ ] Configuration UI in options
- [ ] Monitoring/logging of throttled operations

**Dependencies:** Phase 0.1 (for injection)
**BRD References:** Line 177

---

### 2.3 Error Recovery
**Location:** [`background.js:createFolders()`](../ext/background.js:41-96)
**Status:** Partially Complete (basic error handling exists)

- [x] Basic try-catch error handling (line 87-93)
- [ ] Checkpoint system in folder creation loop
- [ ] Progress state persistence to storage
- [ ] Resume capability after extension reload
- [ ] User notification of resume points
- [ ] Rollback capability for failed batches
- [ ] Detailed error logging with context

**Dependencies:** Phase 2.1 (for state persistence)
**BRD References:** Line 179

---

## Phase 3: Automation (Sprint 4) - HIGH PRIORITY

### 3.1 Periodic Background Scan
**Location:** [`background.js`](../ext/background.js), [`options.html`](../ext/options.html)
**Status:** Not Started

- [ ] Implement alarm API for scheduled tasks
- [ ] Configurable interval in options (5min, 15min, 30min, 1hr, etc.)
- [ ] Run discovery logic on schedule
- [ ] Store discovered senders in local storage
- [ ] Deduplication logic for repeated scans
- [ ] Pause/resume scheduler control
- [ ] Activity logging

**Dependencies:** Phase 2.1 (storage), Phase 3.4 (for auto-mapping)
**BRD References:** Line 91

---

### 3.2 Notification System
**Permission:** `notifications` in [`manifest.json`](../ext/manifest.json)
**Status:** Not Started

- [ ] Add `notifications` permission to manifest
- [ ] Threshold configuration in options
- [ ] Notification creation on threshold exceeded
- [ ] Click action to open discovery tab
- [ ] Notification history tracking
- [ ] User preference for notification types
- [ ] Silent mode option

**Dependencies:** Phase 3.1
**BRD References:** Line 92

---

### 3.3 Auto-Create with Pattern Matching
**New File:** `modules/PatternMatcher.js`
**Status:** Not Started

- [ ] Define pattern confidence scoring system
- [ ] High-confidence pattern rules (e.g., existing domain path)
- [ ] Configuration option for auto-creation threshold
- [ ] Dry-run mode for preview
- [ ] Auto-creation activity log
- [ ] Integration with periodic scan
- [ ] User override/whitelist system

**Dependencies:** Phase 3.1, Phase 2.1
**BRD References:** Line 93

---

### 3.4 Custom Mapping Engine
**New File:** `modules/MappingEngine.js`
**Status:** Not Started

- [ ] Mapping rule schema definition
- [ ] Regex-based pattern matching
- [ ] Contact-based mapping (contact ‚Üí multiple emails)
- [ ] Email-based mapping (single email override)
- [ ] Domain-based mapping (all @domain.com)
- [ ] Priority/precedence system for overlapping rules
- [ ] UI for rule management (CRUD operations)
- [ ] Import/export mapping rules
- [ ] Storage integration
- [ ] Apply mappings in discovery process

**Dependencies:** Phase 2.1 (storage), Phase 0.1 (functional patterns)
**BRD References:** Line 84

---

## Phase 4: Generic Provider System (Sprint 5) - MEDIUM PRIORITY

### 4.1 Provider Abstraction with Parametrized Mappings
**New Files:** 
- `modules/providers/ProviderEngine.js`
- `configs/provider-schemas/` (directory)
- `configs/provider-mappings/` (directory)

**Status:** Not Started

**Architecture:**
```javascript
{
  providerName: "Gmail/Yandex/Custom",
  apiSpec: "path/to/openapi.yaml",
  authType: "OAuth2/Basic/Custom",
  mappings: {
    localProperty: "remoteProperty",
    "from.email": "criteria.from",
    "action.moveTo": "actions[0].addLabel"
  }
}
```

**Tasks:**
- [ ] Design provider configuration schema
- [ ] YAML parser for OpenAPI specs
- [ ] Generic HTTP client with auth plugins
- [ ] OAuth2 flow implementation
- [ ] Basic auth implementation
- [ ] Custom auth plugin system
- [ ] Bidirectional mapping transformer
- [ ] Conflict resolution UI
- [ ] Provider configuration UI
- [ ] Template examples (Gmail, Yandex, Yahoo)
- [ ] Documentation for custom providers

**Dependencies:** Phase 0.1 (for modularity), Phase 2.1 (for storage)
**BRD References:** Lines 106-145, 122-123

---

## Phase 5: UX Essentials (Sprint 6) - MEDIUM PRIORITY

### 5.1 Form Standardization
**Location:** [`ui.html`](../ext/ui.html), [`options.html`](../ext/options.html)
**Status:** Partially Complete

- [ ] Wrap all inputs in `<form>` tags with unique IDs
- [ ] Add `<fieldset>` where logical grouping exists
- [ ] HTML5 validation attributes (`required`, `pattern`, `min`, `max`)
- [ ] Custom validation messages
- [ ] Submit handler with preventDefault
- [ ] Iframe reload logic on submit
- [ ] Error display near form fields
- [ ] Success feedback

**Dependencies:** None
**BRD References:** Lines 216-217

---

### 5.2 Process Controls
**Location:** [`ui.js`](../ext/ui.js)
**Status:** Partially Complete (only start button exists)

- [ ] Add Pause button with AbortController
- [ ] Add Interrupt button (stop at current item)
- [ ] Add Cancel button (rollback changes)
- [ ] Group controls with status displays
- [ ] Disable irrelevant controls during process
- [ ] Keyboard shortcuts for controls
- [ ] Save process state on pause
- [ ] Resume from last checkpoint

**Dependencies:** Phase 2.3 (for checkpoint system)
**BRD References:** Line 220

---

### 5.3 List Management Features
**Location:** [`ui.html`](../ext/ui.html), [`style.css`](../ext/style.css)
**Status:** Partially Complete (discovery list has basic features)

**Current:**
- [x] Select all checkbox (line 187-188)
- [x] Sort by column (line 186-197, 408-413)
- [ ] Select none button
- [ ] Select inverse button
- [ ] Bulk delete action
- [ ] Bulk modify action
- [ ] `<details>` collapsible sections
- [ ] Multi-column sorting (shift+click)
- [ ] Filter/search within lists
- [ ] Export selected to CSV/JSON
- [ ] Pagination for large lists

**Dependencies:** None
**BRD References:** Line 215

---

### 5.4 Keyboard Navigation & Shortcuts
**Location:** [`ui.js`](../ext/ui.js), [`style.css`](../ext/style.css)
**Status:** Partially Complete (basic tab navigation)

- [ ] Tab order attributes (`tabindex`) on all interactive elements
- [ ] Global keyboard event listeners
- [ ] Shortcuts: Ctrl+S (save), Ctrl+Enter (submit), Esc (close modal)
- [ ] Shortcuts: Ctrl+A (select all), Ctrl+Shift+A (select none)
- [ ] Arrow key navigation in lists
- [ ] Focus indicators in CSS (`:focus`, `:focus-visible`)
- [ ] Document shortcuts in UI (help overlay or tooltip)
- [ ] Configuration for custom shortcuts

**Dependencies:** None
**BRD References:** Line 221

---

## Phase 6: Accessibility (Sprint 7) - MEDIUM PRIORITY

### 6.1 Focus Management
**Location:** [`ui.js`](../ext/ui.js)
**Status:** Partially Complete (basic focus exists)

- [ ] Track focus before modal open
- [ ] Restore focus on modal close
- [ ] Move focus to result after async completion
- [ ] Focus trap within modals
- [ ] Skip links for keyboard users
- [ ] Focus visible indicator on form errors
- [ ] Programmatic focus on status messages

**Dependencies:** Phase 5.2
**BRD References:** Line 229

---

### 6.2 ARIA Enhancements
**Location:** [`ui.html`](../ext/ui.html)
**Status:** Partially Complete (basic ARIA exists)

**Current:**
- [x] `aria-label` on some buttons (line 15)
- [ ] `aria-live` regions for status updates
- [ ] `aria-busy` during loading states
- [ ] `aria-describedby` for error messages
- [ ] `aria-expanded` for collapsible sections
- [ ] `aria-selected` for list items
- [ ] `aria-sort` for sortable columns
- [ ] `role` attributes where semantic HTML insufficient

**Dependencies:** None
**BRD References:** Line 228

---

### 6.3 WCAG Compliance Audit
**Location:** [`style.css`](../ext/style.css)
**Status:** Claimed Complete (needs verification)

**Tasks:**
- [ ] Run automated color contrast checker on all color combinations
- [ ] Test with Windows High Contrast Mode
- [ ] Ensure no color-only indicators (add text/icons)
- [ ] Test with screen reader (NVDA, JAWS, VoiceOver)
- [ ] Verify 4.5:1 ratio for normal text
- [ ] Verify 3:1 ratio for large text and UI components
- [ ] Document any exceptions with justification

**Dependencies:** None
**BRD References:** Line 231

---

## Phase 7: Advanced Features (Sprint 8+) - LOW PRIORITY

### 7.1 Staleness Warning
**Location:** [`ui.html`](../ext/ui.html), [`ui.js`](../ext/ui.js)
**Status:** Not Started

- [ ] Visual timestamp indicator in UI
- [ ] Background check for filesystem changes (if API available)
- [ ] Manual "Last updated" label
- [ ] Show difference since last sync
- [ ] Warning banner when rules might be stale
- [ ] Quick refresh action

**Dependencies:** Phase 2.1 (for timestamp storage)
**BRD References:** Line 103

---

### 7.2 Export/Backup
**Location:** [`ui.js`](../ext/ui.js)
**Status:** Not Started

- [ ] Export configuration to JSON
- [ ] Export mapping rules
- [ ] Export stored filter rules
- [ ] Import validation with schema check
- [ ] Import merge vs replace option
- [ ] Backup scheduling option
- [ ] Version tracking in exports

**Dependencies:** Phase 2.1 (storage system)
**BRD References:** Line 104

---

### 7.3 Automation Polish
**Location:** Various
**Status:** Future Consideration

- [ ] Advanced pattern matching with ML suggestions
- [ ] Learning from user corrections
- [ ] Automatic categorization improvements
- [ ] Batch processing optimization
- [ ] Predictive folder suggestions

**Dependencies:** All previous phases
**BRD References:** Various

---

## Implementation Order

### Sprint 1: Foundation (HIGH)
1. ‚úÖ Phase 0.1: Functional refactor
2. ‚úÖ Phase 0.2: Code modularity

### Sprint 2: Critical Path (HIGH)
3. ‚úÖ Phase 1.1: Sanitization validation
4. ‚úÖ Phase 1.2: Consistent formatting
5. ‚úÖ Phase 1.3: Collision resolution

### Sprint 3: Reliability (HIGH)
6. ‚úÖ Phase 2.1: Storage system
7. ‚úÖ Phase 2.2: Rate limiting
8. ‚úÖ Phase 2.3: Error recovery

### Sprint 4: Automation (HIGH)
9. ‚è≥ Phase 3.1: Periodic scan
10. ‚è≥ Phase 3.2: Notifications
11. ‚è≥ Phase 3.3: Auto-create
12. ‚è≥ Phase 3.4: Custom mapping

### Sprint 5: Provider Integration (MEDIUM)
13. ‚è≥ Phase 4.1: Generic provider system

### Sprint 6: User Experience (MEDIUM)
14. ‚è≥ Phase 5.1: Form standardization
15. ‚è≥ Phase 5.2: Process controls
16. ‚è≥ Phase 5.3: List management
17. ‚è≥ Phase 5.4: Keyboard navigation

### Sprint 7: Accessibility (MEDIUM)
18. ‚è≥ Phase 6.1: Focus management
19. ‚è≥ Phase 6.2: ARIA enhancements
20. ‚è≥ Phase 6.3: WCAG audit

### Sprint 8+: Polish (LOW)
21. ‚è≥ Phase 7.x: Advanced features

---

## Status Legend

- ‚úÖ Complete - All tasks finished and tested
- ‚è≥ Planned - Scheduled for future sprint
- üöß In Progress - Currently being worked on
- ‚ö†Ô∏è Blocked - Waiting on dependencies
- ‚ùå Cancelled - No longer needed

---

## Notes

### Priority Rationale

**HIGH Priority:**
- **Architectural Foundation:** Impacts all future work; technical debt prevention
- **Critical Data Handling:** Prevents data corruption and user frustration
- **Persistence & State:** Foundation for automation features
- **Automation:** Core value proposition of the extension

**MEDIUM Priority:**
- **Provider System:** Advanced feature, but complex implementation
- **UX Essentials:** Significant quality of life improvements
- **Accessibility:** Inclusive design is not optional, but can be incremental

**LOW Priority:**
- **Advanced Features:** Nice-to-have enhancements after core is stable

### Risk Areas

1. **Provider System Complexity:** Generic mapping may be overengineered; consider starting with one provider
2. **Rate Limiting:** Need real-world testing with different IMAP servers
3. **Error Recovery:** Checkpoint persistence adds complexity; ensure atomic operations
4. **Accessibility Testing:** Requires specialized tools and expertise

### Success Metrics

- [ ] Zero data corruption incidents
- [ ] <1% failed folder creation rate
- [ ] Automation reduces manual work by >80%
- [ ] WCAG 2.1 AA compliance score >95%
- [ ] All forms validated before submission
- [ ] All processes have cancel capability